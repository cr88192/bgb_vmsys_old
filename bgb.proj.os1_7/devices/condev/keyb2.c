#include <general.h>
#include <x86/io.h>
#include <x86/desc.h>
#include <x86/irq.h>

static byte keybuf[256];
static int keybuf_pos;
static int key_shifts;	//1&=shift, 2&=alt, 4&=ctrl,  65536&=scroll lock, 131072&=num lock, 262144&=caps lock

/* 128 lower, 128 upper */
static byte keyb_conv[256]={ /*
0    1    2    3     4    5    6    7     8    9    A    B */
0x00,0x1B,0x31,0x32, 0x33,0x34,0x35,0x36, 0x37,0x38,0x39,0x30, /*
C    D    E    F     10   11   12   13    14   15   16   17 */
0x2D,0x3D,0x08,0x09, 0x71,0x77,0x65,0x72, 0x74,0x79,0x75,0x69, /*
18   19   1A   1B    1C   1D   1E   1F    20   21   22   23 */
0x6F,0x70,0x5B,0x5D, 0x0A,0x00,0x61,0x73, 0x64,0x66,0x67,0x68, /*
24   25   26   27    28   29   2A   2B    2C   2D   2E   2F */
0x6A,0x6B,0x6C,0x3B, 0x27,0x60,0x00,0x5C, 0x7A,0x78,0x63,0x76, /*
30   31   32   33    34   35   36   37    38   39   3A   3B */
0x62,0x6E,0x6D,0x2C, 0x2E,0x2F,0x00,0x2A, 0x00,0x20,0x00,0x00, /*
3C   3D   3E   3F    40   41   42   43    44   45   46   47 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
48   49   4A   4B    4C   4D   4E   4F    50   51   52   53 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
54   55   56   57    58   59   5A   5B    5C   5D   5E   5F */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
60   61   62   63    64   65   66   67    68   69   6A   6B */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
6C   6D   6E   6F    70   71   72   73    74   75   76   77 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
78   79   7A   7B    7C   7D   7E   7F */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
0    1    2    3     4    5    6    7     8    9    A    B */
0x00,0x1B,0x21,0x40, 0x23,0x24,0x25,0x5E, 0x26,0x2A,0x28,0x29, /*
C    D    E    F     10   11   12   13    14   15   16   17 */
0x5F,0x2B,0x08,0x0F, 0x51,0x57,0x45,0x52, 0x54,0x59,0x55,0x49, /*
18   19   1A   1B    1C   1D   1E   1F    20   21   22   23 */
0x4F,0x50,0x7B,0x7D, 0x0A,0x00,0x41,0x53, 0x44,0x46,0x47,0x48, /*
24   25   26   27    28   29   2A   2B    2C   2D   2E   2F */
0x4A,0x4B,0x4C,0x3A, 0x22,0x7E,0x00,0x7C, 0x5A,0x58,0x43,0x56, /*
30   31   32   33    34   35   36   37    38   39   3A   3B */
0x42,0x4E,0x4D,0x3C, 0x3E,0x3F,0x00,0x00, 0x00,0x20,0x00,0x00, /*
3C   3D   3E   3F    40   41   42   43    44   45   46   47 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
48   49   4A   4B    4C   4D   4E   4F    50   51   52   53 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
54   55   56   57    58   59   5A   5B    5C   5D   5E   5F */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
60   61   62   63    64   65   66   67    68   69   6A   6B */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
6C   6D   6E   6F    70   71   72   73    74   75   76   77 */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, /*
78   79   7A   7B    7C   7D   7E   7F */
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
};

void keyb_handler()
{
	int sc,c,cap;
	sc=inportb(0x60);
	if(sc<0x80)
	{
//		if(sc==0x36)keyb_shifts|=1;
//		if(sc==0x2A)keyb_shifts|=2;
//		if(sc==0x3A)keyb_shifts^=64;

		cap=0;

//		if(keyb_shifts&3)cap=1;
//		if(keyb_shifts&64)cap^=1;

//		Text_WriteLongN(cap,1);
		c=keyb_conv[sc];
		keyb_putch(c);
		return;
	}else
	{
//		if(sc==(0x2A+0x80))keyb_shifts&=0xFD;
//		if(sc==(0x36+0x80))keyb_shifts&=0xFE;
	}
//	Text_WriteLongN(sc,3);
//	Text_WChar(' ');
}

int keyb_putch(int ch)
{
	if(keyb_buf_cnt<252)
	{
		keybuf[keybuf_pos]=ch;
		keybuf_pos++;
	}
}

int kbhit()
{
	return(keybuf_pos);
}

int getch()
{
	int i,k;
//	while(!keyb_buf_cnt)asm("hlt\n");
	k=keyb_buf[0];
	keyb_buf_cnt--;
 	for(i=0;i<255;i++)keyb_buf[i]=keyb_buf[i+1];
	return(k);
}

int Init_Keyboard()
{
	Text_WriteString("Keyboard init.\n");
	keybuf_cnt=0;
	key_shifts=0;

	while(inportb(0x64)&1)inportb(0x60);
	while(inportb(0x64)&2);

	NewIntISR(&keyb_isr,0x21,0);
	enable_irq(1);

	outportb(0x60, 0xED);
	while(inportb(0x64)&2);
	outportb(0x60, led_status);
	while(inportb(0x64)&2);
}